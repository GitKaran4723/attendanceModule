<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#7b1fa2">
    <meta name="description" content="Monthly Attendance Report - BCA BUB">
    <title>Monthly Attendance Report - BCA BUB</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .page-header {
            background: linear-gradient(135deg, #7b1fa2, #9c27b0);
            padding: 25px 20px;
            color: white;
        }

        .page-header h1 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .main-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .filter-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .filter-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            display: block;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }

        .generate-btn {
            background: linear-gradient(135deg, #7b1fa2, #9c27b0);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(123, 31, 162, 0.3);
        }

        .report-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .report-header {
            padding: 20px;
            background: linear-gradient(135deg, #7b1fa2, #9c27b0);
            color: white;
        }

        .report-title {
            margin: 0 0 5px;
            font-size: 1.2rem;
        }

        .report-subtitle {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f9f9f9;
            border-bottom: 1px solid #e0e0e0;
        }

        .stat-box {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #7b1fa2;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
        }

        .report-table-container {
            overflow-x: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .report-table th {
            background: #f5f5f5;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            position: sticky;
            top: 0;
        }

        .report-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .report-table tbody tr:hover {
            background: #f9f5ff;
        }

        .percentage-bar {
            width: 100px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        .percentage-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s;
        }

        .percentage-fill.high {
            background: #4caf50;
        }

        .percentage-fill.medium {
            background: #ff9800;
        }

        .percentage-fill.low {
            background: #f44336;
        }

        .percentage-text {
            font-weight: 600;
            min-width: 45px;
            display: inline-block;
        }

        .percentage-text.high {
            color: #2e7d32;
        }

        .percentage-text.medium {
            color: #f57c00;
        }

        .percentage-text.low {
            color: #c62828;
        }

        .export-buttons {
            padding: 15px 20px;
            background: #f9f9f9;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .export-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: #7b1fa2;
            color: white;
            border-color: #7b1fa2;
        }

        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-state i {
            font-size: 3rem;
            color: #7b1fa2;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 15px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: white;
            text-decoration: none;
            opacity: 0.9;
            margin-top: 10px;
        }

        .back-btn:hover {
            opacity: 1;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="page-header">
        <h1>
            <i class="material-icons">assessment</i>
            Monthly Attendance Report
        </h1>
        <a href="{{ url_for('class_teacher_dashboard') }}" class="back-btn">
            <i class="material-icons">arrow_back</i> Back to Dashboard
        </a>
    </header>

    <div class="main-container">
        <!-- Filters -->
        <div class="filter-card">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Section</label>
                    <select id="sectionSelect">
                        <option value="">Select Section</option>
                        {% for section in sections %}
                        <option value="{{ section.section_id }}">
                            {{ section.section_name }}
                            {% if section.program %} - {{ section.program.program_code }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Month</label>
                    <select id="monthSelect">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Year</label>
                    <select id="yearSelect">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
                <button class="generate-btn" onclick="generateReport()">
                    <i class="material-icons">play_arrow</i>
                    Generate Report
                </button>
            </div>
        </div>

        <!-- Report Container -->
        <div id="reportContainer">
            <div class="empty-state">
                <i class="material-icons">article</i>
                <h3>Select a Section and Generate Report</h3>
                <p>Choose a section and month to view the attendance report.</p>
            </div>
        </div>
    </div>

    <script>
        // Set current month and year
        document.getElementById('monthSelect').value = {{ current_month }};
        document.getElementById('yearSelect').value = {{ current_year }};

        function generateReport() {
            const sectionId = document.getElementById('sectionSelect').value;
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearSelect').value;

            if (!sectionId) {
                alert('Please select a section');
                return;
            }

            const container = document.getElementById('reportContainer');
            container.innerHTML = `
                <div class="loading-state">
                    <i class="material-icons">sync</i>
                    <p>Generating report...</p>
                </div>
            `;

            fetch(`/api/attendance/monthly-report?section_id=${sectionId}&month=${month}&year=${year}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderReport(data);
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <i class="material-icons">error</i>
                                <h3>Error</h3>
                                <p>${data.error}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="material-icons">error</i>
                            <h3>Network Error</h3>
                            <p>Unable to load report. Please try again.</p>
                        </div>
                    `;
                });
        }

        function renderReport(data) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];

            const container = document.getElementById('reportContainer');

            let tableRows = '';
            data.report.forEach((student, index) => {
                const pct = student.percentage;
                const pctClass = pct >= 75 ? 'high' : (pct >= 50 ? 'medium' : 'low');

                tableRows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${student.roll_number || '-'}</td>
                        <td>${student.name}</td>
                        <td>${student.total_classes}</td>
                        <td>${student.present}</td>
                        <td>${student.absent}</td>
                        <td>${student.late}</td>
                        <td>${student.checkin_days}</td>
                        <td>
                            <span class="percentage-bar">
                                <span class="percentage-fill ${pctClass}" style="width: ${pct}%;"></span>
                            </span>
                            <span class="percentage-text ${pctClass}">${pct}%</span>
                        </td>
                    </tr>
                `;
            });

            container.innerHTML = `
                <div class="report-card">
                    <div class="report-header">
                        <h2 class="report-title">${data.section.section_name} - Monthly Attendance</h2>
                        <p class="report-subtitle">${monthNames[data.month - 1]} ${data.year}</p>
                    </div>
                    
                    <div class="report-stats">
                        <div class="stat-box">
                            <div class="stat-value">${data.report.length}</div>
                            <div class="stat-label">Students</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${data.total_classes}</div>
                            <div class="stat-label">Classes Held</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${data.total_working_days}</div>
                            <div class="stat-label">Working Days</div>
                        </div>
                    </div>
                    
                    <div class="report-table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Roll No.</th>
                                    <th>Name</th>
                                    <th>Classes</th>
                                    <th>Present</th>
                                    <th>Absent</th>
                                    <th>Late</th>
                                    <th>Check-ins</th>
                                    <th>Attendance %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows || '<tr><td colspan="9" style="text-align: center;">No students found</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="export-btn" onclick="exportToCSV()">
                            <i class="material-icons">download</i> Export CSV
                        </button>
                        <button class="export-btn" onclick="window.print()">
                            <i class="material-icons">print</i> Print
                        </button>
                    </div>
                </div>
            `;
        }

        function exportToCSV() {
            const table = document.querySelector('.report-table');
            if (!table) return;

            let csv = [];
            const rows = table.querySelectorAll('tr');

            rows.forEach(row => {
                const cols = row.querySelectorAll('td, th');
                const rowData = [];
                cols.forEach(col => {
                    let text = col.innerText.replace(/"/g, '""');
                    rowData.push(`"${text}"`);
                });
                csv.push(rowData.join(','));
            });

            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'attendance_report.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>

</html>